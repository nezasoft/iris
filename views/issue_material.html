<?php
include("../connection/connect.php");include_once("../modules/permissions.php");
//Lets get all approved requisition forms
$req = $conn->prepare("SELECT req.id AS item_id,req.order_no, req.qty, req.req_desc, m.mat_name, us.fname FROM materials_request_form AS req LEFT JOIN materials AS m ON m.id = req.mat_id LEFT JOIN  users AS us ON us.id = req.user_id WHERE req.req_status='A' AND req.site_id='".$_SESSION['IRIS_SITE_ID']."' GROUP BY req.order_no");
$req->execute();
$req_rows = $req->fetchAll(PDO::FETCH_ASSOC);
?>

<div class="card-body pt-0">
<div class="card-header border-0 pt-5">
<h3 class="card-title align-items-start flex-column">
<span class="card-label fw-bolder fs-3 mb-1">Issue Material</span>
</h3>
</div>
	<div class="modal-body scroll-y">
	<div id="form_section">
		<div class="d-flex flex-column scroll-y me-n7 pe-7" id="kt_modal_add_user_scroll" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto" data-kt-scroll-dependencies="#kt_modal_add_user_header" data-kt-scroll-wrappers="#kt_modal_add_user_scroll" data-kt-scroll-offset="300px">
				<div class="mb-7">
			    <label class="required fw-bold fs-6 mb-5">Requisition No</label>
					<div class="col-md-6 fv-row">
						<select class="form-select form-select-solid" id="requisition" data-control="select2" data-hide-search="true" data-placeholder="Select Item">
							<option value="">{--Select Option--}</option>
							<?php 
							foreach($req_rows as $row){
							?>
							<option value="<?php echo $row['order_no']; ?>"><?php echo $row['order_no'] ."--".$row['qty'].'--'.titleCase($row['mat_name']); ?></option>
							<?php
							}
							?>		
						</select>
						<span id="requisition_error" style="color:red;"> *Select Requisition</span>
						</div>
				</div>
		</div>
	
	</div>
	<span class="loader2"><img src="images/loader.gif" width="20px" height="20px"/>Loading...</span><br/><br/>
		<div id="response2"></div><br/>
		<button class="btn btn-xs btn-sm btn-success" id="refresh" > Reload</button><br/><br/>
		<div id="ReqItemsList"></div><hr/>
	<div id="response"></div><br/>
</div>	
</div>
<script>

$("#requisition").change(function(){
req_no = $(this).val();
ajaxrequest('views/issue_items.php?req_no='+req_no, 'ReqItemsList');
});
$(document).ready(function(){
//hide errors
$("#requisition_error").hide();
$(".loader2").hide();

});


$('#requisition').select2();

//Hit Refresh to reload the data
 $("#refresh").click(function(e){
 e.preventDefault();
 req_no = $("#requisition").val();
ajaxrequest('views/issue_items.php?req_no='+req_no, 'ReqItemsList');
 //Show save button
 $("#save_request").fadeIn();
 });

// sends data to a php file, via POST, and displays the received answer
function ajaxrequest(php_file, tagID) {
  var request = (window.XMLHttpRequest) ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');  // XMLHttpRequest object
  var  the_data = '';       // here you can set data to be send to the server (pairs index=value)
  request.open("POST", php_file, true);			// set the request
 // adds  a header to tell the PHP script to recognize the data as is sent via POST
  request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  request.send(the_data);		// calls the send() method with data as parameter
  // Check request status
  // If the response is received completely, will be transferred to the HTML tag with tagID
  request.onreadystatechange = function() {
    if (request.readyState == 4) {
      var resp = request.responseText;        // get the response from php
      document.getElementById(tagID).innerHTML = resp;       // add the response into the tag with the ID from "tagID"
      // calls the parseScript() function, with the response from PHP as argument
      parseScript(resp);
    }
  }
}

// this function create an Array that contains the JS code of every <script> tag in parameter
// then apply the eval() to execute the code in every script collected
function parseScript(strcode) {
  var scripts = new Array();         // Array which will store the script's code
  // Strip out tags
  while(strcode.indexOf("<script") > -1 || strcode.indexOf("</script") > -1) {
    var s = strcode.indexOf("<script");
    var s_e = strcode.indexOf(">", s);
    var e = strcode.indexOf("</script", s);
    var e_e = strcode.indexOf(">", e);  
    // Add to scripts array
    scripts.push(strcode.substring(s_e+1, e));
    // Strip from strcode
    strcode = strcode.substring(0, s) + strcode.substring(e_e+1);
  }  
  // Loop through every script collected and eval it
  for(var i=0; i<scripts.length; i++) {
    try {
      eval(scripts[i]);
    }
    catch(ex) {
      // do what you want here when a script fails
    }
  }
}
</script>	
<script>
function issueItem(req_id,mat_id,qty){
$("#response_"+req_id+"").empty();
$(".loader_"+req_id+"").show();

var myData = 'req_id='+ req_id + '&mat_id=' + mat_id + '&qty=' + qty; //build a post data structure
jQuery.ajax({
type: "POST", // Post / Get method
url: "process/issue_material.php", //Where form data is sent on submission
dataType:"text", // Data type, HTML, json etc.
data:myData, //Form variables
success:function(response){
$("#response_"+req_id+"").append(response); 
$(".loader_"+req_id+"").fadeOut();
$("#response_"+req_id+"").fadeIn();
}

});
//Send  request to server
}

</script>