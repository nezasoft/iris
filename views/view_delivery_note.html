<?php
require_once("../connection/connect.php");
 include_once("../modules/permissions.php");
$order_no = sanitize_string($_GET['order_no']);
//get order details
$order = $conn->prepare("SELECT d.id AS item_id, d.delivery_no, d.del_details, d.delivery_name, sf.site_name AS site_from, st.site_name AS site_to, d.del_date, d.delivery_status, us.fname FROM delivery_note AS d LEFT JOIN materials AS m ON m.id = d.mat_id LEFT JOIN sites AS sf ON sf.id = d.site_id LEFT JOIN sites AS st ON st.id = d.to_site_id LEFT JOIN users AS us ON us.id = d.user_id  WHERE d.delivery_no='".$order_no."' GROUP BY d.delivery_no LIMIT 1");
$order->execute();
$order_row = $order->fetch(PDO::FETCH_ASSOC);
//Company details
$company = $conn->prepare("SELECT * FROM company");
$company->execute();
$company_row = $company->fetch(PDO::FETCH_ASSOC);
$t_type = $order_row['delivery_status'];
			   
if($t_type=='A'){
$status = '<font color="#2ECC71">Approved</font>'; 
}elseif($t_type=='P'){
$status = '<font color="#E67E22">Pending</font>'; 
}elseif($t_type=='R'){
$status = '<font color="#E74C3C">Rejected</font>';
}elseif($t_type=='C'){
$status = '<font color="#3498DB">Completed</font>';  
}elseif($t_type=='N'){
$status = '<font color="#3498DB">New</font>';				   
}

?>

<div class="modal-header" id="kt_modal_add_user_header">
	<h2 class="fw-bolder">Delivery Note</h2>
	<div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
	<span class="svg-icon svg-icon-1">
	<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="black" />
	<rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="black" />
		</svg>
	</span>
	</div>
	</div>
	<div class="modal-body scroll-y mx-5">
	  <!-- Main Content -->
	  <div id="print_section"  style="font-size:10px;background:#fff;" >
	    <header>
  <div class="row align-items-center" style="font-size:10px;">
        <table width="100%" border="0">
          <tr>
            <td> <div class="col-sm-6 order-sm-0" style="padding:10px;"> <!--<strong><?php echo $company_row['company_name']; ?></strong>-->
      <address>
      <i class="fas fa-map-pin" style="color:#E67E22;font-size:10px;"></i>   <?php echo $company_row['phy_add']; ?><br />
      <i class="fas fa-envelope" style="color:#E67E22;font-size:10px"></i> P.O Box <?php echo $company_row['postal_add']."-".$company_row['postal_code']; ?><br />
      <i class="fas fa-phone" style="color:#E67E22;font-size:10px"></i> <?php echo $company_row['mobile_no']; ?><br />
      <i class="fas fa-at" style="color:#E67E22;font-size:10px"></i> <?php echo $company_row['email']; ?><br />
	  <i class="fas fa-globe" style="color:#E67E22;font-size:10px"></i> <?php echo $company_row['website']; ?>
      </address>
      </div></td>
            <td><div style="align:left" class="">
              <div align="right"><img id="logo" width="100px;" height="100px;" src="images/logo.png" title="Willstone Homes" alt="Willstone Homes" />
                        </div>
            </div></td>
          </tr>
        </table>
        <table width="100%" border="0" style="margin-bottom:10px;">
      <tr>
      <td width="35%">&nbsp;</td>
        <td width="30%"><div align="center" style=" padding:5px; font-size:12px; border: 1px solid #E67E22;"><strong>Delivery Note</strong></div></td>
        <td width="35%">&nbsp;</td>
      </tr>
    </table>
  </div>
  <hr/>
  </header>
    <table width="100%" border="0">
      <tr>
        <td width="7%"><div align="right"><strong>Date</strong>:</div></td>
        <td width="31%"><div align="left"><?php echo $order_row['del_date']; ?></div></td>
        <td width="45%"><div align="right"><strong>Del. No:</strong></div></td>
        <td width="9%"><div align="left"><?php echo $order_row['delivery_no']; ?></div></td>
      </tr>
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td><div align="right"><strong>Status:</strong></div></td>
        <td><div align="left"><?php echo $status; ?></div></td>
      </tr>
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td><div align="right"><strong>Deliver to:</strong></div></td>
        <td><div align="left"><?php echo titleCase($order_row['site_to']); ?></div></td>
      </tr>
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td><div align="right"><strong>Prepared By:</strong></div></td>
        <td><div align="left"><?php echo titleCase($order_row['fname']); ?></div></td>
      </tr>
    </table>
    <hr/>
   <!-- <table width="100%" border="0" style="margin-bottom:10px;">
      <tr>
      <td width="35%">&nbsp;</td>
        <td width="30%"><div align="center" style=" padding:5px; font-size:12px; border: 1px solid #E67E22;"><strong>Purchase Order</strong></div></td>
        <td width="35%">&nbsp;</td>
      </tr>
    </table>-->
    <div>
    <div>
	 <?php 
	 //get order items
	 $order_items = $conn->prepare("SELECT d.id AS item_id, d.qty, d.del_details, m.mat_name FROM delivery_note AS d LEFT JOIN materials AS m ON m.id = d.mat_id   WHERE d.delivery_no='".$order_no."' ORDER BY d.id ASC");
	 $order_items->execute();
	 $item_rows = $order_items->fetchAll(PDO::FETCH_ASSOC);
	 ?>
      <div class="table-responsive" style="border:1px solid #000;padding:5px; background:#fff;">
        <table class="table mb-0">
		<thead >
          <tr class="fw-bolder text-muted bg-light-dark">
		   <td><strong>#</strong></td>
            <td><strong>Item</strong></td>	
            <td><strong>Qty</strong></td>
			<td><strong>Description</strong></td>
          </tr>
        </thead>
          <tbody>
		  <?php 
		  $count =0;
		  $total = 0;
		  foreach($item_rows as $row){
		  $count++;
		  ?>
            <tr>
              <td><?php echo $count; ?></td>
              <td><?php echo titleCase($row['mat_name']); ?></td>			  
              <td><?php echo $row['qty']; ?></td>
			  <td><?php echo titleCase($row['del_details']); ?></td>
            </tr>
		<?php } ?>	
          </tbody>
        </table>		
      </div>
	  <br/>
		<div id="box_remarks" style="border: 2px solid #0000;">Remarks:<br/><?php echo $order_row['delivery_name']; ?></div>
		<br/>
	  </div>
    </div>
    </div>
	<br/><br/>
<button  onclick="jQuery('#print_section').print()" class="btn btn-primary btn-sm btn-small"  id="print">Print <i class="fas fa-print"></i></button>
</div>
