<?php
require_once("../connection/connect.php");
//Get all orders 
$orders = $conn->prepare("SELECT po.id AS item_id, order_no, sup_name FROM purchase_order AS po LEFT JOIN suppliers AS s ON s.id = po.sup_id WHERE order_status='A' AND site_id=".$_SESSION['IRIS_SITE_ID']." GROUP BY order_no ORDER BY po.id DESC");
$orders->execute();
$order_rows = $orders->fetchAll(PDO::FETCH_ASSOC);

function generateRandomString($length = 10) {
    $characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $charactersLength = strlen($characters);
    $randomString = '';
    for ($i = 0; $i < $length; $i++) {
        $randomString .= $characters[rand(0, $charactersLength - 1)];
    }
    return $randomString;
   }

    $ref_no = strtoupper(generateRandomString());
	
	//save ref_no in session
	$_SESSION['IRIS_INWARD_REF_NO'] = $ref_no;
?>


<div class="modal-header" id="kt_modal_add_user_header">
	<h2 class="fw-bolder">New Inward</h2>
	<div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
	<span class="svg-icon svg-icon-1">
	<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="black" />
	<rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="black" />
		</svg>
	</span>
	</div>
	</div>
	<div class="modal-body scroll-y mx-5 mx-xl-15 my-7">
	<div id="form_section">
		<div class="fv-row mb-7">
			   <label class="required fw-bold fs-6 mb-5">Purchase Order No</label>
					<div class=" fv-row">
						<select class="form-select form-select-solid" id="purchase_order" data-control="select2" data-hide-search="true" data-placeholder="Select Item">
							<option value="">{--Select Order--}</option>
							<?php 
							foreach($order_rows as $row){
							?>
							<option value="<?php echo $row['order_no']; ?>"><?php echo $row['order_no']." - ".titleCase($row['sup_name']); ?></option>
							<?php
							}
							?>		
						</select>
						<span id="purchase_order_error" style="color:red;"> *Select Order</span>
						</div>
				</div>
	

		  <div class="fv-row mb-7">
			<label class="required fw-bold fs-6 mb-2">Del. Note No</label>
			<input type="text" name="fname" id="del_no" autocomplete="off" class="form-control form-control-solid mb-3 mb-lg-0" placeholder="Delivery Note No"  />
			<span id="del_no_error" style="color:red;"> *Enter delivery no</span>
			</div>
			<div class="fv-row mb-7">
			<label class="required fw-bold fs-6 mb-2">Vehicle Reg. No</label>
			<input type="text" name="fname" id="vehicle_no" autocomplete="off" class="form-control form-control-solid mb-3 mb-lg-0" placeholder="Vehicle Reg. No"  />
			<span id="vehicle_no_error" style="color:red;"> *Enter vehicle no</span>
			</div>
			<div class="fv-row mb-7">
			<label class="required fw-bold fs-6 mb-2">Delivered By.</label>
			<input type="text"  id="delivered_by" autocomplete="off" class="form-control form-control-solid mb-3 mb-lg-0" placeholder="Delivered By"  />
			<span id="delivered_by_error" style="color:red;"> *Enter Name of delivery person</span>
			</div>

	       <div class="d-flex flex-column scroll-y me-n7 pe-7" id="kt_modal_add_user_scroll" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto" data-kt-scroll-dependencies="#kt_modal_add_user_header" data-kt-scroll-wrappers="#kt_modal_add_user_scroll" data-kt-scroll-offset="300px">
																
		   <div class="fv-row mb-7">
			<label class="required fw-bold fs-6 mb-2">Remarks</label>
			<input type="text"  id="remark" autocomplete="off" class="form-control form-control-solid mb-3 mb-lg-0" placeholder="Remarks"  />
			<span id="remark_error" style="color:red;"> *Enter remarks</span>
			</div>
		</div>
	
		<span class="loader2"><img src="images/loader.gif" width="20px" height="20px"/>Loading...</span><br/><br/>
		<div id="response2"></div><br/>
		<button class="btn btn-xs btn-sm btn-success" id="refresh" > Reload</button><br/><br/>
		<div id="ReqItemsList"></div><hr/>
		<br><div id="fields_error" class="alert alert-danger">* Please fill in all the highlighted fields.</div><br/>
		<div>
		<button type="submit" id="save_request" class="btn btn-primary" data-kt-users-modal-action="submit">
		<span class="indicator-label">Save</span>							
		</button>
		<span class="loader"><img src="images/loader.gif" width="30px" height="30px"/>Requesting...</span><br/><br/>
		
		</div>
		</div>
		<div id="response"></div><br/>
	</div>
</div>
<script>
//hide errors
$("#purchase_order_error").hide();
$("#del_no_error").hide();
$("#vehicle_no_error").hide();
$("#delivered_by_error").hide();
$("#remark_error").hide();
$(".loader").hide();
$(".loader2").hide();
$("#save_request").hide();
$("#fields_error").hide();
$(document).ready(function(){
$('#purchase_order').select2({
dropdownParent: $("#ModalContentAddNew")
});

$("#purchase_order").change(function(){
$('#response2').empty();
order_no = $(this).val();
ref_no = "<?php echo $ref_no; ?>";
//Send request to server to get order details
var myData = 'order_no=' + order_no + '&ref_no=' + ref_no ; //build a post data structure
jQuery.ajax({
type: "POST", // Post / Get method
url: "process/save_inward_temp.php", //Where form data is sent on submission
dataType:"text", // Data type, HTML, json etc.
data:myData, //Form variables
success:function(response){
$("#response2").append(response); 
$('.loader2').fadeOut();
$('#save_request').fadeIn();
$('#response2').fadeIn();
 ajaxrequest('views/inward_items.php', 'ReqItemsList');
}

});

});

$("#save_request").click(function(e){
e.preventDefault();
purchase_order = $("#purchase_order").val();
del_no = $("#del_no").val();
vehicle_no = $("#vehicle_no").val();
delivered_by = $("#delivered_by").val();
remark = $("#remark").val();
error = false;
$("#response").empty();

if(purchase_order ===''){
error =true;
$("#purchase_order_error").fadeIn();
$("#purchase_order").focus();
}else{
$("#purchase_order_error").fadeOut();
}
if(del_no ===''){
error =true;
$("#del_no_error").fadeIn();
$("#del_no").focus();
}else{
$("#del_no_error").fadeOut();
}
if(vehicle_no ===''){
error =true;
$("#vehicle_no_error").fadeIn();
$("#vehicle_no").focus();
}else{
$("#vehicle_no_error").fadeOut();
}
if(delivered_by ===''){
error =true;
$("#delivered_by_error").fadeIn();
$("#delivered_by").focus();
}else{
$("#delivered_by_error").fadeOut();
}
if(remark ===''){
error =true;
$("#remark_error").fadeIn();
$("#remark").focus();
}else{
$("#remark_error").fadeOut();
}



if(error ==false){
//hide submit button
$("#save_request").fadeOut();
$(".loader").fadeIn();
var myData = 'delivery_no='+ del_no + '&vehicle_no=' + vehicle_no + '&delivered_by=' + delivered_by + '&remark=' + remark; //build a post data structure
jQuery.ajax({
type: "POST", // Post / Get method
url: "process/save_inward.php", //Where form data is sent on submission
dataType:"text", // Data type, HTML, json etc.
data:myData, //Form variables
success:function(response){
$("#response").append(response); 
$('.loader').fadeOut();
$('#save_request').fadeIn();
$('#response').fadeIn();
}

});
}
});

});

 //Hit Refresh to reload the data
 $("#refresh").click(function(e){
 e.preventDefault();
 ajaxrequest('views/inward_items.php', 'ReqItemsList');
 //Show save button
 $("#save_request").fadeIn();
 });

// sends data to a php file, via POST, and displays the received answer
function ajaxrequest(php_file, tagID) {
  var request = (window.XMLHttpRequest) ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');  // XMLHttpRequest object
  var  the_data = '';       // here you can set data to be send to the server (pairs index=value)
  request.open("POST", php_file, true);			// set the request
 // adds  a header to tell the PHP script to recognize the data as is sent via POST
  request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  request.send(the_data);		// calls the send() method with data as parameter
  // Check request status
  // If the response is received completely, will be transferred to the HTML tag with tagID
  request.onreadystatechange = function() {
    if (request.readyState == 4) {
      var resp = request.responseText;        // get the response from php
      document.getElementById(tagID).innerHTML = resp;       // add the response into the tag with the ID from "tagID"
      // calls the parseScript() function, with the response from PHP as argument
      parseScript(resp);
    }
  }
}

// this function create an Array that contains the JS code of every <script> tag in parameter
// then apply the eval() to execute the code in every script collected
function parseScript(strcode) {
  var scripts = new Array();         // Array which will store the script's code
  // Strip out tags
  while(strcode.indexOf("<script") > -1 || strcode.indexOf("</script") > -1) {
    var s = strcode.indexOf("<script");
    var s_e = strcode.indexOf(">", s);
    var e = strcode.indexOf("</script", s);
    var e_e = strcode.indexOf(">", e);  
    // Add to scripts array
    scripts.push(strcode.substring(s_e+1, e));
    // Strip from strcode
    strcode = strcode.substring(0, s) + strcode.substring(e_e+1);
  }  
  // Loop through every script collected and eval it
  for(var i=0; i<scripts.length; i++) {
    try {
      eval(scripts[i]);
    }
    catch(ex) {
      // do what you want here when a script fails
    }
  }
}
</script>
												
													