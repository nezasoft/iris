<?php
require_once("../connection/connect.php");
include_once("../modules/permissions.php");
$order_no = sanitize_string($_GET['item_id']);
//get order details
$order = $conn->prepare("SELECT bq.id AS item_id, bq.boq_no, bq.boq_name, bq.boq_date, bq.boq_time, bq.units, s.site_name, us.fname FROM boq AS bq LEFT JOIN sites AS s ON s.id = bq.site_id LEFT JOIN users AS us ON us.id = bq.user_id  WHERE bq.id='".$order_no."' LIMIT 1");
$order->execute();
$order_row = $order->fetch(PDO::FETCH_ASSOC);
$units = $order_row['units'];
//Company details
$company = $conn->prepare("SELECT * FROM company");
$company->execute();
$company_row = $company->fetch(PDO::FETCH_ASSOC);
//get all sections
//get sections
$sections = $conn->prepare("SELECT id AS item_id, section_name FROM building_sections ORDER BY section_name ASC");
$sections->execute();
$section_rows = $sections->fetchAll(PDO::FETCH_ASSOC);
?>
<div class="modal-header" id="kt_modal_add_user_header">
	<h2 class="fw-bolder">BOQ >> <?php echo $order_row['boq_name']; ?></h2>
	<div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
	<span class="svg-icon svg-icon-1">
	<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="black" />
	<rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="black" />
		</svg>
	</span>
	</div>
	</div>	
<div class="modal-body">
<header>
  <div class="row align-items-center" style="font-size:10px;background:#fff;">
        <table width="100%" border="0">
          <tr>
            <td> <div class="col-sm-6 order-sm-0" style="padding:10px;"> <!--<strong><?php echo $company_row['company_name']; ?></strong>-->
      <address>
      <i class="fas fa-map-pin" style="color:#E67E22;font-size:10px;"></i>   <?php echo $company_row['phy_add']; ?><br />
      <i class="fas fa-envelope" style="color:#E67E22;font-size:10px"></i> P.O Box <?php echo $company_row['postal_add']."-".$company_row['postal_code']; ?><br />
      <i class="fas fa-phone" style="color:#E67E22;font-size:10px"></i> <?php echo $company_row['mobile_no']; ?><br />
      <i class="fas fa-at" style="color:#E67E22;font-size:10px"></i> <?php echo $company_row['email']; ?><br />
	  <i class="fas fa-globe" style="color:#E67E22;font-size:10px"></i> <?php echo $company_row['website']; ?>
      </address>
      </div></td>
            <td><div style="align:left" class="">
              <div align="right"><img id="logo" width="100px;" height="100px;" src="images/logo.png" title="Willstone Homes" alt="Willstone Homes" />
                        </div>
            </div></td>
          </tr>
        </table>
        <table width="100%" border="0" style="margin-bottom:10px;">
      <tr>
      <td width="35%">&nbsp;</td>
        <td width="30%"><div align="center" style=" padding:5px; font-size:12px; border: 1px solid #E67E22;"><strong>BOQ</strong></div></td>
        <td width="35%">&nbsp;</td>
      </tr>
    </table>
  </div>
  <hr>
  </header>
  <main style="font-size:10px;background:#fff;">

    <table width="100%" border="0">
      <tr>
        <td width="7%"><div align="right"><strong>Date</strong>:</div></td>
        <td width="31%"><div align="left"><?php echo $order_row['boq_date']; ?></div></td>
        <td width="45%"><div align="right"><strong>BOQ No:</strong></div></td>
        <td width="9%"><div align="left"><?php echo $order_row['boq_no']; ?></div></td>
      </tr>
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td><div align="right"><strong>Site:</strong></div></td>
        <td><div align="left"><?php echo titleCase($order_row['site_name']); ?></div></td>
      </tr>
    </table>
    <hr>
    <table width="100%" border="0">
      <tr>
        <td width="87%"><strong>BOQ Name</strong></td>
        <td width="13%"><strong>Units:</strong></td>
        </tr>
      <tr>
        <td><?php echo $order_row['boq_name']; ?><br /></td>
        <td><?php echo $order_row['units']; ?></td>
        </tr>
    </table>
  <hr>

	 <div class="table-responsive">
	 <div id="print_section" style="background:#fff;">
	 <table border="1" width="100%">
	 <thead>
	 <tr>
	 <td>BOQ Details</td>
	 </tr>
	 
	 </thead>
	 <tbody>
	<?php foreach($section_rows as $s_row){ ?>
	 <tr>
	 <td colspan="2"><strong><?php echo strtoupper($s_row['section_name']); ?><strong/></td>
	 </tr>
	 <tr>
	 <td>
	 <?php
	 //Get sub sections
$sub_sections = $conn->prepare("SELECT id AS item_id,sub_section_name FROM sub_section WHERE section_id='".$s_row['item_id']."'  ORDER BY sub_section_name ASC");
$sub_sections->execute();
$sub_sections_rows = $sub_sections->fetchAll(PDO::FETCH_ASSOC);
$sub_section_total = 0.0;
$work_total = 0.00;
foreach($sub_sections_rows as $sb_row){
$sub_section_total += $work_total;
	 ?>
			 <table width="100%">
			 <thead>
			 <tr >
			 <td  colspan="2"><strong><?php echo titleCase($sb_row['sub_section_name']); ?></strong></td>
			 </tr> 
			 </thead>
			 <tbody>
			 <tr>
			 <td>
			 <?php
			 //get BOQ details
			 $boq = $conn->prepare("SELECT bq.id AS item_id, bq.qty, bq.rate, bq.remark, m.mat_name,w.id AS work_id, bq.item_id AS mat_id, w.work_unit_name, p.pack_name FROM boq_items AS bq LEFT JOIN materials AS m ON m.id = bq.item_id LEFT JOIN work_unit AS w ON w.id = bq.work_id LEFT JOIN packages AS p ON p.id = m.pack_id WHERE w.sub_section_id='".$sb_row['item_id']."'");
			 $boq->execute();
			 $boq_rows = $boq->fetchAll(PDO::FETCH_ASSOC);
			 
			 ?>
				<table  width="100%">
				 <thead>
				  <tr  style="background:#E67E22;color:#fff;">
				 <td>Work Unit</td>
				 <td>Material</td>
				 <td>Remark</td>
				 <td>Rate</td>
				 <td>Qty</td>
				 <td>Total</td>
				 <td>LPO Rate</td>
				 <td>LPO Qty</td>
				 <td>LPO Total</td>
				 <td>LPO Var. (Qty) </td>
				 <td>LPO Var.(Amt) </td>
				 <td>Del. (Qty) </td>
				 <td>Del. Var. </td>
				 <td>Usage (Qty)</td>
				 <td>Usage Var. (Qty)</td>
				 <td>Completion</td>
				 </tr> 
				 </thead>
				 <tbody>
				 <?php 
				 $work_total = 0.00;
				 foreach($boq_rows as $bq_row){ 
				 $work_total += $bq_row['rate']*$bq_row['qty'];
				 $work_id = $bq_row['work_id'];
				 $item_id = $bq_row['mat_id'];
				 $compare = $conn->prepare("SELECT po.id AS po_id, SUM(po.qty) AS po_qty, po.rate AS po_rate, SUM(g.qty) AS inw_qty FROM purchase_order AS po LEFT JOIN site_materials_request_form AS sr ON sr.id = po.req_id LEFT JOIN good_inward AS g ON g.order_id = po.id WHERE sr.work_id='".$work_id."' AND sr.mat_id='".$item_id."'");
				 $compare->execute();
				 $compare_row = $compare->fetch(PDO::FETCH_ASSOC);
				 $used = $compare_row['inw_qty'];
				 $expected = $bq_row['qty']*$units;
				 
				 //Get materials usage
				 $mat_used = $conn->prepare("SELECT mi.id AS item_id, SUM(mi.qty) AS usage_qty  FROM materials_issuance AS mi LEFT JOIN materials_request_form AS mr ON mr.id = mi.requisition_id WHERE mr.work_id='".$work_id."' ");
				 $mat_used->execute();
				 $mat_used_row = $mat_used->fetch(PDO::FETCH_ASSOC);
				 $mat_usage = $mat_used_row['usage_qty'];
                 $mat_usage_variance = ($bq_row['qty']*$units) - $mat_used_row['usage_qty'];
				 $completion = number_format(($mat_usage/$expected)*100,2,".",",");				 
				 ?>
				 <tr>
				 <td><?php echo titleCase($bq_row['work_unit_name']); ?></td>
				 <td><?php echo $bq_row['mat_name']; ?></td>
				 <td><?php echo $bq_row['remark']; ?></td>				 
				 <td><?php echo number_format($bq_row['rate']*$units,2,".",","); ?></td>
				 <td><?php echo number_format($bq_row['qty']*$units,2,".",","); ?></td>
				 <td><?php echo number_format(($bq_row['rate']*$bq_row['qty'])*$units,2,".",","); ?></td>
				 <td><?php echo $compare_row['po_rate']; ?></td>
				 <td><?php echo $compare_row['po_qty']; ?></td>				 
				 <td><?php echo number_format($compare_row['po_rate']*$compare_row['po_qty'],2,".",","); ?></td>
				 <td><?php echo number_format(($bq_row['qty']*$units)-$compare_row['po_qty'],2,".",","); ?></td></td>
				 <td><?php echo number_format((($bq_row['rate']*$bq_row['qty'])*$units)-($compare_row['po_rate']*$compare_row['po_qty']),2,".",","); ?></td>
				 <td><?php echo $compare_row['inw_qty']; ?></td>
				 <td><?php echo number_format(($bq_row['qty']*$units)-$compare_row['inw_qty'],2,".",","); ?></td>
				 <td><?php echo number_format($mat_usage,2,".",","); ?></td>
				 <td><?php echo number_format($mat_usage_variance,2,".",","); ?></td>
				 <td><div class="h-4px w-100 bg-light mb-5" data-bs-toggle="tooltip" title="This project <?php echo $completion; ?>% completed">
				 <div class="bg-primary rounded h-4px" role="progressbar" style="width: <?php echo $completion; ?>%" aria-valuenow="<?php echo $completion; ?>" aria-valuemin="0" aria-valuemax="100"></div>
				</div></td>				 
				 </tr>
				 <?php } ?>
				 <tr>
				 <td colspan="5"><div align="right"><strong>Total<strong/></div></td>
				 <td><strong><?php echo number_format($work_total*$units,2,".",","); ?><strong/></td>
				 </tr>
				 </tbody>				 
			    </table>
			 </td>
			 </tr>
			 </tbody>
			 </table>			 
			 <?php } ?>
			 </td>
			 </tr>
	 <?php } ?>
	 </tbody>
	 </table>
	 </div><br/><br/>
<button  onclick="jQuery('#print_section').print()" class="btn btn-primary btn-sm btn-small"  id="print">Print <i class="fas fa-print"></i></button>
 </div>
</div>
